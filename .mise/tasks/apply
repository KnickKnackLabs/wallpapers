#!/usr/bin/env bash
#MISE description="Apply wallpapers from config (all or select one)"
#MISE alias="default"
#USAGE arg "[name]" help="Workspace name/id to apply (optional - shows picker if omitted)"
#USAGE complete "name" run="jq -r '.workspaces[] | (.id // .name) + \":\" + (.description // .name)' ~/.config/wallpapers/config.json 2>/dev/null" descriptions=#true
#USAGE flag "--all" help="Apply to all spaces without prompting"
set -e

OUTPUT_DIR="$HOME/.local/share/wallpapers"
CONFIG_FILE="$HOME/.config/wallpapers/config.json"

if [ ! -f "$CONFIG_FILE" ]; then
    gum style --foreground 196 "❌ Config not found. Run: mise run config:init"
    exit 1
fi

# Auto-detect screen resolution
SCREEN_RES=$(system_profiler SPDisplaysDataType | grep -i "Resolution:" | head -1 | sed 's/.*: //' | sed 's/ Retina//' | sed 's/ //g')
SCREEN_W=$(echo "$SCREEN_RES" | cut -d'x' -f1)
SCREEN_H=$(echo "$SCREEN_RES" | cut -d'x' -f2)

# If --all flag, generate all and apply to all spaces
if [ "${usage_all:-}" = "true" ]; then
    # Count workspaces in config
    CONFIG_COUNT=$(jq '.workspaces | length' "$CONFIG_FILE")

    # Get actual space count
    SPACE_INFO=$(swift src/current-space.swift)
    SPACE_COUNT=$(echo "$SPACE_INFO" | cut -d'/' -f2)

    # Check for mismatch
    if [ "$CONFIG_COUNT" -ne "$SPACE_COUNT" ]; then
        gum style --foreground 226 "⚠️  Mismatch: config has $CONFIG_COUNT workspaces, but you have $SPACE_COUNT spaces"
        echo ""
        if [ "$CONFIG_COUNT" -gt "$SPACE_COUNT" ]; then
            DIFF=$((CONFIG_COUNT - SPACE_COUNT))
            gum style --foreground 245 "To add $DIFF space(s):"
            echo "  1. Open Mission Control (Ctrl+Up or swipe up with 3 fingers)"
            echo "  2. Hover over the top row and click the '+' button"
            echo "  3. Repeat until you have $CONFIG_COUNT spaces"
        else
            DIFF=$((SPACE_COUNT - CONFIG_COUNT))
            gum style --foreground 245 "You have $DIFF extra space(s). Either:"
            echo "  • Add more workspaces to your config: mise run config:edit"
            echo "  • Or remove spaces: Mission Control → hover space → click X"
        fi
        echo ""
        if ! gum confirm "Continue anyway?"; then
            exit 0
        fi
    fi

    # Generate and get file list
    OUTPUT=$(swift src/setup.swift --width "$SCREEN_W" --height "$SCREEN_H")
    FILES=()
    while IFS= read -r line; do
        if [[ "$line" == FILE:* ]]; then
            FILES+=("${line#FILE:}")
        elif [[ "$line" != MODE:* ]]; then
            echo "$line"
        fi
    done <<< "$OUTPUT"

    if [ ${#FILES[@]} -eq 0 ]; then
        gum style --foreground 196 "❌ No wallpapers to apply"
        exit 1
    fi

    gum style --foreground 245 "Applying ${#FILES[@]} wallpaper(s) to spaces..."

    # Helper function to wait until we're on the expected space
    wait_for_space() {
        local expected=$1
        local max_attempts=10
        local attempt=0
        while [ $attempt -lt $max_attempts ]; do
            local current=$(swift src/current-space.swift | cut -d'/' -f1)
            if [ "$current" = "$expected" ]; then
                return 0
            fi
            sleep 0.3
            ((attempt++))
        done
        echo "Warning: Could not confirm space $expected (on $current)" >&2
        return 1
    }

    CURRENT_SPACE=$(swift src/current-space.swift | cut -d'/' -f1)

    # Navigate to space 1
    if [ "$CURRENT_SPACE" -gt 1 ]; then
        for ((j = CURRENT_SPACE; j > 1; j--)); do
            osascript -e 'tell application "System Events" to key code 123 using control down'
            sleep 0.3
        done
        wait_for_space 1
    fi

    # Apply each wallpaper
    for i in "${!FILES[@]}"; do
        FILE="${FILES[$i]}"
        EXPECTED_SPACE=$((i + 1))

        # Verify we're on the expected space before setting wallpaper
        wait_for_space "$EXPECTED_SPACE"

        echo "Setting wallpaper $((i+1))/${#FILES[@]}: $(basename "$FILE")"
        osascript -e "tell application \"System Events\" to set picture of current desktop to \"$FILE\""
        sleep 0.3

        if [ $i -lt $((${#FILES[@]} - 1)) ]; then
            osascript -e 'tell application "System Events" to key code 124 using control down'
            sleep 0.3
        fi
    done

    # Return to original space
    FINAL_SPACE=${#FILES[@]}
    STEPS_BACK=$((FINAL_SPACE - CURRENT_SPACE))
    if [ "$STEPS_BACK" -gt 0 ]; then
        for ((i = 0; i < STEPS_BACK; i++)); do
            osascript -e 'tell application "System Events" to key code 123 using control down'
            sleep 0.3
        done
    fi

    gum style --foreground 46 "✅ All wallpapers applied!"
    exit 0
fi

# Get workspace names from config for picker
WORKSPACES=$(jq -r '.workspaces | to_entries[] | "\(.key + 1). \(.value.name) [\(.value.id // (.value.name | ascii_downcase | gsub(" "; "-") | gsub("[^a-z0-9-]"; "")))]"' "$CONFIG_FILE")

# If name provided as argument, use it; otherwise show picker
ARG_NAME="${usage_name:-$1}"
if [ -n "$ARG_NAME" ]; then
    SELECTION="$ARG_NAME"
else
    # Show picker with "All spaces" option first
    SELECTION=$(echo -e "All spaces\n$WORKSPACES" | gum choose --header "Apply wallpaper to:")

    if [ "$SELECTION" = "All spaces" ]; then
        exec mise run apply --all
    fi
fi

# Extract workspace id from selection (handle both "1. name [id]" format and direct id/name)
if [[ "$SELECTION" =~ \[([^\]]+)\]$ ]]; then
    WORKSPACE_ID="${BASH_REMATCH[1]}"
elif [[ "$SELECTION" =~ ^[0-9]+\. ]]; then
    # Format: "1. name [id]" - extract id
    WORKSPACE_ID=$(echo "$SELECTION" | sed 's/.*\[//' | sed 's/\]//')
else
    # Direct name/id provided - normalize to lowercase
    WORKSPACE_ID=$(echo "$SELECTION" | tr '[:upper:]' '[:lower:]')
fi

# Get workspace config with defaults merged
WORKSPACE_CONFIG=$(jq -r --arg search "$WORKSPACE_ID" '
    .defaults as $defaults |
    .workspaces | to_entries[] |
    select(
        (.value.id // (.value.name | ascii_downcase | gsub(" "; "-") | gsub("[^a-z0-9-]"; ""))) == $search
        or (.value.name | ascii_downcase) == $search
    ) |
    {
        name: .value.name,
        id: (.value.id // (.value.name | ascii_downcase | gsub(" "; "-") | gsub("[^a-z0-9-]"; ""))),
        index: (.key + 1),
        bgColor: (.value.bgColor // $defaults.bgColor // "#000000"),
        textColor: (.value.textColor // $defaults.textColor // "#ffffff"),
        description: .value.description
    } |
    "NAME:\(.name)\nID:\(.id)\nINDEX:\(.index)\nBGCOLOR:\(.bgColor)\nTEXTCOLOR:\(.textColor)" +
    (if .description then "\nDESC:\(.description)" else "" end)
' "$CONFIG_FILE")

if [ -z "$WORKSPACE_CONFIG" ]; then
    gum style --foreground 196 "❌ Workspace not found: $WORKSPACE_ID"
    exit 1
fi

# Parse workspace config
WS_NAME=$(echo "$WORKSPACE_CONFIG" | grep "^NAME:" | cut -d: -f2-)
WS_ID=$(echo "$WORKSPACE_CONFIG" | grep "^ID:" | cut -d: -f2-)
WS_INDEX=$(echo "$WORKSPACE_CONFIG" | grep "^INDEX:" | cut -d: -f2-)
WS_BGCOLOR=$(echo "$WORKSPACE_CONFIG" | grep "^BGCOLOR:" | cut -d: -f2-)
WS_TEXTCOLOR=$(echo "$WORKSPACE_CONFIG" | grep "^TEXTCOLOR:" | cut -d: -f2-)
WS_DESC=$(echo "$WORKSPACE_CONFIG" | grep "^DESC:" | cut -d: -f2-)

# Build generate.swift args
GEN_ARGS=("$WS_NAME" "--id" "$WS_ID" "--index" "$WS_INDEX" "--bg-color" "$WS_BGCOLOR" "--text-color" "$WS_TEXTCOLOR" "--width" "$SCREEN_W" "--height" "$SCREEN_H")
if [ -n "$WS_DESC" ]; then
    GEN_ARGS+=("-d" "$WS_DESC")
fi

# Generate just this wallpaper
echo "Generating: $WS_NAME"
swift src/generate.swift "${GEN_ARGS[@]}" > /dev/null

# Apply
WALLPAPER_PATH="$OUTPUT_DIR/$WS_ID.$WS_INDEX.png"
osascript -e "tell application \"System Events\" to set picture of current desktop to \"$WALLPAPER_PATH\""
gum style --foreground 46 "✅ Applied: $(basename "$WALLPAPER_PATH")"
