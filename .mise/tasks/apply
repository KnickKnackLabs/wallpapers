#!/usr/bin/env bash
#MISE description="Apply wallpapers from config (all or select one)"
#MISE alias="default"
#USAGE arg "[name]" help="Workspace name/id to apply (optional - shows picker if omitted)"
#USAGE complete "name" run="jq -r '.workspaces[] | (.id // .name) + \":\" + (.description // .name)' ~/.config/wallpapers/config.json 2>/dev/null" descriptions=#true
#USAGE flag "--all" help="Apply to all spaces without prompting"
set -e

OUTPUT_DIR="$HOME/.local/share/wallpapers"
CONFIG_FILE="$HOME/.config/wallpapers/config.json"

if [ ! -f "$CONFIG_FILE" ]; then
    gum style --foreground 196 "❌ Config not found. Run: mise run config:init"
    exit 1
fi

# Require Hammerspoon
APP_PATH="/Applications/Hammerspoon.app"
HS_CLI="$APP_PATH/Contents/Frameworks/hs/hs"
if [ ! -x "$HS_CLI" ] || ! pgrep -x "Hammerspoon" > /dev/null; then
    gum style --foreground 196 "❌ Hammerspoon not running. Run: mise run hammerspoon:setup"
    exit 1
fi

# Alternate wallpaper filename suffix to bust macOS cache.
# macOS won't reload a wallpaper if the path hasn't changed,
# so we alternate between .a.png and .b.png.
cache_bust() {
    local base="${1%.png}"
    if [ -f "${base}.a.png" ]; then
        rm -f "${base}.a.png"
        echo "${base}.b.png"
    else
        rm -f "${base}.b.png"
        echo "${base}.a.png"
    fi
}

# Auto-detect screen resolution
SCREEN_RES=$(system_profiler SPDisplaysDataType | grep -i "Resolution:" | head -1 | sed 's/.*: //' | sed 's/ Retina//' | sed 's/ //g')
SCREEN_W=$(echo "$SCREEN_RES" | cut -d'x' -f1)
SCREEN_H=$(echo "$SCREEN_RES" | cut -d'x' -f2)

# If --all flag, generate all and apply to all spaces
if [ "${usage_all:-}" = "true" ]; then
    # Count workspaces in config
    CONFIG_COUNT=$(jq '.workspaces | length' "$CONFIG_FILE")

    # Get actual space count
    SPACE_COUNT=$("$HS_CLI" -c "return wp.spaceCount()" 2>/dev/null)
    if [ -z "$SPACE_COUNT" ] || [ "$SPACE_COUNT" = "error" ]; then
        gum style --foreground 196 "❌ Could not get space count from Hammerspoon"
        exit 1
    fi

    # Check for mismatch
    if [ "$CONFIG_COUNT" -ne "$SPACE_COUNT" ]; then
        gum style --foreground 226 "⚠️  Mismatch: config has $CONFIG_COUNT workspaces, but you have $SPACE_COUNT spaces"
        echo ""
        if [ "$CONFIG_COUNT" -gt "$SPACE_COUNT" ]; then
            DIFF=$((CONFIG_COUNT - SPACE_COUNT))
            gum style --foreground 245 "To add $DIFF space(s):"
            echo "  1. Open Mission Control (Ctrl+Up or swipe up with 3 fingers)"
            echo "  2. Hover over the top row and click the '+' button"
            echo "  3. Repeat until you have $CONFIG_COUNT spaces"
        else
            DIFF=$((SPACE_COUNT - CONFIG_COUNT))
            gum style --foreground 245 "You have $DIFF extra space(s). Either:"
            echo "  • Add more workspaces to your config: mise run config:edit"
            echo "  • Or remove spaces: Mission Control → hover space → click X"
        fi
        echo ""
        if ! gum confirm "Continue anyway?"; then
            exit 0
        fi
    fi

    # Generate and get file list
    OUTPUT=$(swift src/setup.swift --width "$SCREEN_W" --height "$SCREEN_H")
    FILES=()
    while IFS= read -r line; do
        if [[ "$line" == FILE:* ]]; then
            FILES+=("${line#FILE:}")
        elif [[ "$line" != MODE:* ]]; then
            echo "$line"
        fi
    done <<< "$OUTPUT"

    if [ ${#FILES[@]} -eq 0 ]; then
        gum style --foreground 196 "❌ No wallpapers to apply"
        exit 1
    fi

    gum style --foreground 245 "Applying ${#FILES[@]} wallpaper(s) to spaces..."

    CURRENT_SPACE=$("$HS_CLI" -c "return wp.currentSpace()" 2>/dev/null)

    # Apply each wallpaper
    for i in "${!FILES[@]}"; do
        FILE="${FILES[$i]}"
        TARGET_SPACE=$((i + 1))

        "$HS_CLI" -c "return wp.gotoSpace($TARGET_SPACE)" 2>/dev/null
        sleep 0.3

        SUFFIXED=$(cache_bust "$FILE")
        cp "$FILE" "$SUFFIXED"
        echo "Setting wallpaper $((i+1))/${#FILES[@]}: $(basename "$SUFFIXED")"
        osascript -e "tell application \"System Events\" to set picture of current desktop to \"$SUFFIXED\""
        sleep 0.3
    done

    # Return to original space
    "$HS_CLI" -c "return wp.gotoSpace($CURRENT_SPACE)" 2>/dev/null

    gum style --foreground 46 "✅ All wallpapers applied!"
    exit 0
fi

# Get workspace names from config for picker
WORKSPACES=$(jq -r '.workspaces | to_entries[] | "\(.key + 1). \(.value.name) [\(.value.id // (.value.name | ascii_downcase | gsub(" "; "-") | gsub("[^a-z0-9-]"; "")))]"' "$CONFIG_FILE")

# If name provided as argument, use it; otherwise show picker
ARG_NAME="${usage_name:-$1}"
if [ -n "$ARG_NAME" ]; then
    SELECTION="$ARG_NAME"
else
    # Show picker with "All spaces" option first
    SELECTION=$(echo -e "All spaces\n$WORKSPACES" | gum choose --header "Apply wallpaper to:")

    if [ "$SELECTION" = "All spaces" ]; then
        exec mise run apply --all
    fi
fi

# Extract workspace id from selection (handle both "1. name [id]" format and direct id/name)
if [[ "$SELECTION" =~ \[([^\]]+)\]$ ]]; then
    WORKSPACE_ID="${BASH_REMATCH[1]}"
elif [[ "$SELECTION" =~ ^[0-9]+\. ]]; then
    # Format: "1. name [id]" - extract id
    WORKSPACE_ID=$(echo "$SELECTION" | sed 's/.*\[//' | sed 's/\]//')
else
    # Direct name/id provided - normalize to lowercase
    WORKSPACE_ID=$(echo "$SELECTION" | tr '[:upper:]' '[:lower:]')
fi

# Get workspace config with defaults merged
WORKSPACE_CONFIG=$(jq -r --arg search "$WORKSPACE_ID" '
    .defaults as $defaults |
    .workspaces | to_entries[] |
    select(
        (.value.id // (.value.name | ascii_downcase | gsub(" "; "-") | gsub("[^a-z0-9-]"; ""))) == $search
        or (.value.name | ascii_downcase) == $search
    ) |
    {
        name: .value.name,
        id: (.value.id // (.value.name | ascii_downcase | gsub(" "; "-") | gsub("[^a-z0-9-]"; ""))),
        index: (.key + 1),
        bgColor: (.value.bgColor // $defaults.bgColor // "#000000"),
        textColor: (.value.textColor // $defaults.textColor // "#ffffff"),
        description: .value.description,
        style: (.value.style // $defaults.style // "classic"),
        borderText: (.value.borderText // $defaults.borderText // true),
        watermark: (.value.watermark // $defaults.watermark // true),
        borderOpacity: (.value.borderOpacity // $defaults.borderOpacity // null),
        watermarkOpacity: (.value.watermarkOpacity // $defaults.watermarkOpacity // null),
        gradientOpacity: (.value.gradientOpacity // $defaults.gradientOpacity // null)
    } |
    "NAME:\(.name)\nID:\(.id)\nINDEX:\(.index)\nBGCOLOR:\(.bgColor)\nTEXTCOLOR:\(.textColor)" +
    (if .description then "\nDESC:\(.description)" else "" end) +
    "\nSTYLE:\(.style)" +
    "\nBORDERTEXT:\(.borderText)" +
    "\nWATERMARK:\(.watermark)" +
    (if .borderOpacity then "\nBORDEROPACITY:\(.borderOpacity)" else "" end) +
    (if .watermarkOpacity then "\nWATERMARKOPACITY:\(.watermarkOpacity)" else "" end) +
    (if .gradientOpacity then "\nGRADIENTOPACITY:\(.gradientOpacity)" else "" end)
' "$CONFIG_FILE")

if [ -z "$WORKSPACE_CONFIG" ]; then
    gum style --foreground 196 "❌ Workspace not found: $WORKSPACE_ID"
    exit 1
fi

# Parse workspace config
WS_NAME=$(echo "$WORKSPACE_CONFIG" | grep "^NAME:" | cut -d: -f2-)
WS_ID=$(echo "$WORKSPACE_CONFIG" | grep "^ID:" | cut -d: -f2-)
WS_INDEX=$(echo "$WORKSPACE_CONFIG" | grep "^INDEX:" | cut -d: -f2-)
WS_BGCOLOR=$(echo "$WORKSPACE_CONFIG" | grep "^BGCOLOR:" | cut -d: -f2-)
WS_TEXTCOLOR=$(echo "$WORKSPACE_CONFIG" | grep "^TEXTCOLOR:" | cut -d: -f2-)
WS_DESC=$(echo "$WORKSPACE_CONFIG" | grep "^DESC:" | cut -d: -f2-)
WS_BORDERTEXT=$(echo "$WORKSPACE_CONFIG" | grep "^BORDERTEXT:" | cut -d: -f2-)
WS_WATERMARK=$(echo "$WORKSPACE_CONFIG" | grep "^WATERMARK:" | cut -d: -f2-)
WS_STYLE=$(echo "$WORKSPACE_CONFIG" | grep "^STYLE:" | cut -d: -f2-)
WS_BORDEROPACITY=$(echo "$WORKSPACE_CONFIG" | grep "^BORDEROPACITY:" | cut -d: -f2-)
WS_WATERMARKOPACITY=$(echo "$WORKSPACE_CONFIG" | grep "^WATERMARKOPACITY:" | cut -d: -f2-)
WS_GRADIENTOPACITY=$(echo "$WORKSPACE_CONFIG" | grep "^GRADIENTOPACITY:" | cut -d: -f2-)

# Build generate.swift args
GEN_ARGS=("$WS_NAME" "--id" "$WS_ID" "--index" "$WS_INDEX" "--bg-color" "$WS_BGCOLOR" "--text-color" "$WS_TEXTCOLOR" "--width" "$SCREEN_W" "--height" "$SCREEN_H")
if [ -n "$WS_DESC" ]; then
    GEN_ARGS+=("-d" "$WS_DESC")
fi
GEN_ARGS+=("--style" "$WS_STYLE")
# Classic-specific decoration flags
if [ "$WS_STYLE" = "classic" ]; then
    if [ "$WS_BORDERTEXT" = "true" ]; then
        GEN_ARGS+=("--border-text")
    fi
    if [ "$WS_WATERMARK" = "true" ]; then
        GEN_ARGS+=("--watermark")
    fi
    if [ -n "$WS_BORDEROPACITY" ]; then
        GEN_ARGS+=("--border-opacity" "$WS_BORDEROPACITY")
    fi
    if [ -n "$WS_WATERMARKOPACITY" ]; then
        GEN_ARGS+=("--watermark-opacity" "$WS_WATERMARKOPACITY")
    fi
fi
if [ -n "$WS_GRADIENTOPACITY" ]; then
    GEN_ARGS+=("--gradient-opacity" "$WS_GRADIENTOPACITY")
fi

# Generate just this wallpaper
echo "Generating: $WS_NAME"
swift src/generate.swift "${GEN_ARGS[@]}" > /dev/null

# Apply with cache busting
WALLPAPER_PATH="$OUTPUT_DIR/$WS_ID.$WS_INDEX.png"
SUFFIXED=$(cache_bust "$WALLPAPER_PATH")
cp "$WALLPAPER_PATH" "$SUFFIXED"
osascript -e "tell application \"System Events\" to set picture of current desktop to \"$SUFFIXED\""
gum style --foreground 46 "✅ Applied: $(basename "$SUFFIXED")"
