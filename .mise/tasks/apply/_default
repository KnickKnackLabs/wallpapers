#!/usr/bin/env bash
#MISE description="Apply workspace config (wallpapers, apps, or both)"
#MISE alias="default"
#USAGE arg "[name]" help="Workspace name/id to apply (optional - shows picker if omitted)"
#USAGE complete "name" run="jq -r '.workspaces[] | (.id // .name) + \":\" + (.description // .name)' ~/.config/wallpapers/config.json 2>/dev/null" descriptions=#true
#USAGE flag "--wallpapers" help="Only apply wallpapers"
#USAGE flag "--apps" help="Only launch and position apps"
#USAGE flag "--clean" help="Close previous app windows before applying"
set -e

OUTPUT_DIR="$HOME/.local/share/wallpapers"
CONFIG_FILE="$HOME/.config/wallpapers/config.json"

if [ ! -f "$CONFIG_FILE" ]; then
    gum style --foreground 196 "❌ Config not found. Run: mise run config:init"
    exit 1
fi

# Require butthair
if ! command -v butthair &>/dev/null; then
    gum style --foreground 196 "❌ butthair not found. Install with: shiv install butthair"
    exit 1
fi

# Require Hammerspoon
APP_PATH="/Applications/Hammerspoon.app"
HS_CLI="$APP_PATH/Contents/Frameworks/hs/hs"
if [ ! -x "$HS_CLI" ] || ! pgrep -x "Hammerspoon" > /dev/null; then
    gum style --foreground 196 "❌ Hammerspoon not running. Run: mise run hammerspoon:setup"
    exit 1
fi

# Determine what to apply (default: both)
DO_WALLPAPERS=true
DO_APPS=true
if [ "${usage_wallpapers:-}" = "true" ] || [ "${usage_apps:-}" = "true" ]; then
    DO_WALLPAPERS="${usage_wallpapers:-false}"
    DO_APPS="${usage_apps:-false}"
fi

# Alternate wallpaper filename suffix to bust macOS cache.
cache_bust() {
    local base="${1%.png}"
    if [ -f "${base}.a.png" ]; then
        rm -f "${base}.a.png"
        echo "${base}.b.png"
    else
        rm -f "${base}.b.png"
        echo "${base}.a.png"
    fi
}

# Auto-detect screen resolution
SCREEN_RES=$(system_profiler SPDisplaysDataType | grep -i "Resolution:" | head -1 | sed 's/.*: //' | sed 's/ Retina//' | sed 's/ //g')
SCREEN_W=$(echo "$SCREEN_RES" | cut -d'x' -f1)
SCREEN_H=$(echo "$SCREEN_RES" | cut -d'x' -f2)

# Apply to all spaces
{
    CONFIG_COUNT=$(jq 'if .spaces then .spaces | length elif .workspaces then .workspaces | length else 0 end' "$CONFIG_FILE")

    SPACE_COUNT=$("$HS_CLI" -c "return wp.spaceCount()" 2>/dev/null)
    if [ -z "$SPACE_COUNT" ] || [ "$SPACE_COUNT" = "error" ]; then
        gum style --foreground 196 "❌ Could not get space count from Hammerspoon"
        exit 1
    fi

    if [ "$CONFIG_COUNT" -ne "$SPACE_COUNT" ]; then
        gum style --foreground 226 "⚠️  Mismatch: config has $CONFIG_COUNT workspaces, but you have $SPACE_COUNT spaces"
        echo ""
        if [ "$CONFIG_COUNT" -gt "$SPACE_COUNT" ]; then
            DIFF=$((CONFIG_COUNT - SPACE_COUNT))
            gum style --foreground 245 "To add $DIFF space(s):"
            echo "  1. Open Mission Control (Ctrl+Up or swipe up with 3 fingers)"
            echo "  2. Hover over the top row and click the '+' button"
            echo "  3. Repeat until you have $CONFIG_COUNT spaces"
        else
            DIFF=$((SPACE_COUNT - CONFIG_COUNT))
            gum style --foreground 245 "You have $DIFF extra space(s). Either:"
            echo "  • Add more workspaces to your config: mise run config:edit"
            echo "  • Or remove spaces: Mission Control → hover space → click X"
        fi
        echo ""
        if ! gum confirm "Continue anyway?"; then
            exit 0
        fi
    fi

    # --- Wallpapers ---
    if [ "$DO_WALLPAPERS" = "true" ]; then
        OUTPUT=$(swift run setup -- --width "$SCREEN_W" --height "$SCREEN_H")
        FILES=()
        while IFS= read -r line; do
            if [[ "$line" == FILE:* ]]; then
                FILES+=("${line#FILE:}")
            elif [[ "$line" != MODE:* ]]; then
                echo "$line"
            fi
        done <<< "$OUTPUT"

        if [ ${#FILES[@]} -eq 0 ]; then
            gum style --foreground 196 "❌ No wallpapers to apply"
            exit 1
        fi

        gum style --foreground 245 "Applying ${#FILES[@]} wallpaper(s) to spaces..."

        CURRENT_SPACE=$("$HS_CLI" -c "return wp.currentSpace()" 2>/dev/null)

        for i in "${!FILES[@]}"; do
            FILE="${FILES[$i]}"
            TARGET_SPACE=$((i + 1))
            "$HS_CLI" -c "return wp.gotoSpace($TARGET_SPACE)" 2>/dev/null
            sleep 0.3
            SUFFIXED=$(cache_bust "$FILE")
            cp "$FILE" "$SUFFIXED"
            echo "  wallpaper $((i+1))/${#FILES[@]}: $(basename "$SUFFIXED")"
            osascript -e "tell application \"System Events\" to set picture of current desktop to \"$SUFFIXED\""
            sleep 0.3
        done

        "$HS_CLI" -c "return wp.gotoSpace($CURRENT_SPACE)" 2>/dev/null
        gum style --foreground 46 "✅ Wallpapers applied"
    fi

    # --- Apps ---
    if [ "$DO_APPS" = "true" ]; then
        # Get screen usable area from Hammerspoon (accounts for menu bar)
        SCREEN_JSON=$(butthair screen:info -- -j 2>/dev/null)
        USABLE_W=$(echo "$SCREEN_JSON" | jq '.usable.w')
        USABLE_H=$(echo "$SCREEN_JSON" | jq '.usable.h')
        USABLE_Y=$(echo "$SCREEN_JSON" | jq '.usable.y')

        GAP=$(jq '.defaults.gap // 8' "$CONFIG_FILE")

        STATE_FILE="$HOME/.local/share/wallpapers/.apply-state"
        mkdir -p "$(dirname "$STATE_FILE")"

        CURRENT_SPACE=$(butthair spaces:current -- -i 2>/dev/null)

        # Optionally close previous windows first
        if [ "${usage_clean:-false}" = "true" ] && [ -f "$STATE_FILE" ] && [ -s "$STATE_FILE" ]; then
            PREV_COUNT=$(grep -c . "$STATE_FILE")
            gum style --foreground 245 "Closing $PREV_COUNT previous window(s)..."
            PREV_SPACES=()
            PREV_WINS=()
            while IFS= read -r line; do
                [ -z "$line" ] && continue
                PREV_SPACES+=("$(echo "$line" | cut -d' ' -f1)")
                PREV_WINS+=("$(echo "$line" | cut -d' ' -f2)")
            done < "$STATE_FILE"
            PREV_LAST_SPACE=""
            for i in "${!PREV_WINS[@]}"; do
                if [ "${PREV_SPACES[$i]}" != "$PREV_LAST_SPACE" ]; then
                    butthair spaces:goto -- "${PREV_SPACES[$i]}" < /dev/null 2>/dev/null || true
                    sleep 0.3
                    PREV_LAST_SPACE="${PREV_SPACES[$i]}"
                fi
                butthair windows:close -- "${PREV_WINS[$i]}" < /dev/null 2>/dev/null || true
            done
        fi
        : > "$STATE_FILE"

        gum style --foreground 245 "Positioning apps..."

        for s in $(seq 0 $((CONFIG_COUNT - 1))); do
            SPACE_NUM=$((s + 1))
            ZONES_JSON=$(jq -c ".spaces[$s].zones" "$CONFIG_FILE")
            ZONE_COUNT=$(echo "$ZONES_JSON" | jq 'length')

            # Skip spaces with no apps
            TOTAL_APPS=$(echo "$ZONES_JSON" | jq '[.[] | (.apps // []) | length] | add // 0')
            [ "$TOTAL_APPS" -eq 0 ] && continue

            # Navigate to this space
            butthair spaces:goto -- "$SPACE_NUM" < /dev/null 2>/dev/null
            sleep 0.5

            # Zone bounds math (matches WallpaperKit/Generator.swift)
            EDGE_GAPS=$((GAP * 2))
            INNER_GAPS=$(( (ZONE_COUNT - 1) * GAP ))
            AVAIL_W=$((USABLE_W - EDGE_GAPS - INNER_GAPS))
            AVAIL_H=$((USABLE_H - GAP * 2))
            ZONE_Y=$((USABLE_Y + GAP))
            TOTAL_FLEX=$(echo "$ZONES_JSON" | jq '[.[] | (.flex // 1)] | add')

            OFFSET_X=$GAP
            for z in $(seq 0 $((ZONE_COUNT - 1))); do
                FLEX=$(echo "$ZONES_JSON" | jq ".[$z].flex // 1")
                ZONE_NAME=$(echo "$ZONES_JSON" | jq -r ".[$z].name")
                APPS_JSON=$(echo "$ZONES_JSON" | jq -c ".[$z].apps // []")
                APPS_COUNT=$(echo "$APPS_JSON" | jq 'length')

                ZONE_W=$(echo "($AVAIL_W * $FLEX + $TOTAL_FLEX / 2) / $TOTAL_FLEX" | bc)

                if [ "$APPS_COUNT" -gt 0 ]; then
                    for a in $(seq 0 $((APPS_COUNT - 1))); do
                        APP_NAME=$(echo "$APPS_JSON" | jq -r ".[$a].app")
                        APP_POS=$(echo "$APPS_JSON" | jq -r ".[$a].position")
                        APP_WIDTH_FRAC=$(echo "$APPS_JSON" | jq -r ".[$a].width")

                        # Inset windows by gap so the zone wallpaper shows as a border
                        INSET=$GAP

                        if [ "$APP_POS" = "bottom" ]; then
                            APP_HEIGHT_FRAC=$(echo "$APPS_JSON" | jq -r ".[$a].height")
                            # Sub-region: bottom portion of zone
                            SUB_X=$OFFSET_X
                            SUB_W=$ZONE_W
                            SUB_H=$(echo "$AVAIL_H * $APP_HEIGHT_FRAC" | bc)
                            SUB_Y=$(echo "$ZONE_Y + $AVAIL_H - $SUB_H" | bc)
                            # Inset all edges
                            APP_X=$(echo "$SUB_X + $INSET" | bc)
                            APP_Y=$(echo "$SUB_Y + $INSET" | bc)
                            APP_W=$(echo "$SUB_W - $INSET * 2" | bc)
                            APP_H=$(echo "$SUB_H - $INSET * 2" | bc)
                        elif [ "$APP_POS" = "right" ]; then
                            # Sub-region: right portion of zone
                            SUB_W=$(echo "$ZONE_W * $APP_WIDTH_FRAC" | bc)
                            SUB_X=$(echo "$OFFSET_X + $ZONE_W - $SUB_W" | bc)
                            SUB_Y=$ZONE_Y
                            SUB_H=$AVAIL_H
                            # Inset all edges
                            APP_X=$(echo "$SUB_X + $INSET" | bc)
                            APP_Y=$(echo "$SUB_Y + $INSET" | bc)
                            APP_W=$(echo "$SUB_W - $INSET * 2" | bc)
                            APP_H=$(echo "$SUB_H - $INSET * 2" | bc)
                        else
                            SUB_W=$(echo "$ZONE_W * $APP_WIDTH_FRAC" | bc)
                            SUB_X=$OFFSET_X
                            SUB_Y=$ZONE_Y
                            SUB_H=$AVAIL_H
                            APP_X=$(echo "$SUB_X + $INSET" | bc)
                            APP_Y=$(echo "$SUB_Y + $INSET" | bc)
                            APP_W=$(echo "$SUB_W - $INSET * 2" | bc)
                            APP_H=$(echo "$SUB_H - $INSET * 2" | bc)
                        fi

                        echo "  space $SPACE_NUM/$ZONE_NAME: $APP_NAME at x=$APP_X y=$APP_Y ${APP_W}x${APP_H}"

                        # Create a new window on this space
                        "$HS_CLI" -c "
local app = hs.application.get('$APP_NAME')
if not app then
    hs.application.open('$APP_NAME')
    return 'launched'
else
    app:activate()
    hs.eventtap.keyStroke({'cmd'}, 'n')
    return 'new_window'
end
" 2>/dev/null
                        sleep 1

                        # Position the frontmost window and record its ID
                        WIN_ID=$("$HS_CLI" -c "
local app = hs.application.get('$APP_NAME')
if not app then return 'error: app not found' end
local win = app:focusedWindow()
if not win then return 'error: no window' end
win:setFrame(hs.geometry.rect($APP_X, $APP_Y, $APP_W, $APP_H))
return tostring(win:id())
" 2>/dev/null)
                        echo "$SPACE_NUM $WIN_ID" >> "$STATE_FILE"
                        sleep 0.3
                    done
                fi

                OFFSET_X=$((OFFSET_X + ZONE_W + GAP))
            done
        done

        butthair spaces:goto -- "$CURRENT_SPACE" < /dev/null 2>/dev/null
        gum style --foreground 46 "✅ Apps positioned"
    fi

}
