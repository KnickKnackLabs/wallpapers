#!/usr/bin/env bash
#MISE description="Switch to a workspace by name"
#USAGE arg "[name]" help="Workspace name/id, or '-' to go back (shows picker if omitted)"
#USAGE complete "name" run="jq -r '.workspaces[] | (.id // .name) + \":\" + (.description // .name)' ~/.config/wallpapers/config.json 2>/dev/null" descriptions=#true
set -e

CONFIG_FILE="$HOME/.config/wallpapers/config.json"
STATE_DIR="$HOME/.local/state/wallpapers"
PREVIOUS_FILE="$STATE_DIR/previous-space"

if [ ! -f "$CONFIG_FILE" ]; then
    gum style --foreground 196 "❌ Config not found. Run: mise run config:init"
    exit 1
fi

# Require Hammerspoon
APP_PATH="/Applications/Hammerspoon.app"
HS_CLI="$APP_PATH/Contents/Frameworks/hs/hs"
if [ ! -x "$HS_CLI" ] || ! pgrep -x "Hammerspoon" > /dev/null; then
    gum style --foreground 196 "❌ Hammerspoon not running. Run: mise run hammerspoon:setup"
    exit 1
fi

# Get current space
CURRENT=$("$HS_CLI" -c "return wp.currentSpace()" 2>/dev/null)
if [ -z "$CURRENT" ] || [ "$CURRENT" = "error" ]; then
    gum style --foreground 196 "❌ Could not get current space from Hammerspoon"
    exit 1
fi

TARGET="${usage_name:-$1}"

# Handle "-" (go back)
if [ "$TARGET" = "-" ]; then
    if [ ! -f "$PREVIOUS_FILE" ]; then
        gum style --foreground 196 "❌ No previous workspace"
        exit 1
    fi
    TARGET_INDEX=$(cat "$PREVIOUS_FILE")

    if [ "$CURRENT" -eq "$TARGET_INDEX" ]; then
        gum style --foreground 245 "Already on previous workspace"
        exit 0
    fi
# Handle no argument (show picker)
elif [ -z "$TARGET" ]; then
    WORKSPACES=$(jq -r '.workspaces | to_entries[] | "\(.key + 1). \(.value.name)"' "$CONFIG_FILE")

    SELECTION=$(echo "$WORKSPACES" | gum choose --header "Go to workspace:")

    # Extract index from selection (format: "1. name")
    TARGET_INDEX=$(echo "$SELECTION" | cut -d'.' -f1)

    if [ "$CURRENT" -eq "$TARGET_INDEX" ]; then
        gum style --foreground 245 "Already on that workspace"
        exit 0
    fi
# Handle name argument
else
    # Find workspace index by name or id
    TARGET_LOWER=$(echo "$TARGET" | tr '[:upper:]' '[:lower:]')
    TARGET_INDEX=$(jq -r --arg search "$TARGET_LOWER" '
        .workspaces | to_entries[] |
        select(
            (.value.id // (.value.name | ascii_downcase | gsub(" "; "-") | gsub("[^a-z0-9-]"; ""))) == $search
            or (.value.name | ascii_downcase) == $search
        ) |
        .key + 1
    ' "$CONFIG_FILE")

    if [ -z "$TARGET_INDEX" ]; then
        gum style --foreground 196 "❌ Workspace not found: $TARGET"
        exit 1
    fi

    if [ "$CURRENT" -eq "$TARGET_INDEX" ]; then
        gum style --foreground 245 "Already on workspace $TARGET"
        exit 0
    fi
fi

# Save current space before navigating
mkdir -p "$STATE_DIR"
echo "$CURRENT" > "$PREVIOUS_FILE"

# Navigate
RESULT=$("$HS_CLI" -c "return wp.gotoSpace($TARGET_INDEX)" 2>/dev/null || echo "false")
if [ "$RESULT" != "true" ]; then
    gum style --foreground 196 "❌ Failed to navigate to space $TARGET_INDEX"
    exit 1
fi
