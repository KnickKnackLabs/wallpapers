#!/usr/bin/env bash
#MISE description="Switch to a workspace by name"
#USAGE arg "<name>" help="Workspace name or id to switch to"
set -e

CONFIG_FILE="$HOME/.config/wallpapers/config.json"

if [ ! -f "$CONFIG_FILE" ]; then
    gum style --foreground 196 "❌ Config not found. Run: mise run config:init"
    exit 1
fi

TARGET="${usage_name:-$1}"
if [ -z "$TARGET" ]; then
    gum style --foreground 196 "❌ Usage: mise run goto <name>"
    exit 1
fi

# Find workspace index in config
TARGET_INDEX=$(swift -e '
import Foundation
struct Config: Codable { let workspaces: [Workspace] }
struct Workspace: Codable { let name: String; let id: String? }
let data = FileManager.default.contents(atPath: NSString(string: "~/.config/wallpapers/config.json").expandingTildeInPath)!
let config = try! JSONDecoder().decode(Config.self, from: data)
let search = CommandLine.arguments.last!.lowercased()
for (i, w) in config.workspaces.enumerated() {
    let id = w.id ?? w.name.lowercased().replacingOccurrences(of: " ", with: "-").filter { $0.isLetter || $0.isNumber || $0 == "-" }
    if id == search || w.name.lowercased() == search {
        print(i + 1)
        break
    }
}
' "$TARGET")

if [ -z "$TARGET_INDEX" ]; then
    gum style --foreground 196 "❌ Workspace not found: $TARGET"
    exit 1
fi

# Get current space
CURRENT=$(swift src/current-space.swift | cut -d'/' -f1)

if [ "$CURRENT" -eq "$TARGET_INDEX" ]; then
    gum style --foreground 245 "Already on workspace $TARGET"
    exit 0
fi

# Calculate direction and steps
if [ "$TARGET_INDEX" -gt "$CURRENT" ]; then
    STEPS=$((TARGET_INDEX - CURRENT))
    # Right arrow = key code 124
    KEY_CODE=124
else
    STEPS=$((CURRENT - TARGET_INDEX))
    # Left arrow = key code 123
    KEY_CODE=123
fi

# Navigate
for ((i = 0; i < STEPS; i++)); do
    osascript -e "tell application \"System Events\" to key code $KEY_CODE using control down"
    sleep 0.3
done
