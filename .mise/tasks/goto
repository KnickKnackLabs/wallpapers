#!/usr/bin/env bash
#MISE description="Switch to a workspace by name"
#USAGE arg "[name]" help="Workspace name/id, or '-' to go back (shows picker if omitted)"
#USAGE complete "name" run="jq -r '.workspaces[] | (.id // .name) + \":\" + (.description // .name)' ~/.config/wallpapers/config.json 2>/dev/null" descriptions=#true
set -e

CONFIG_FILE="$HOME/.config/wallpapers/config.json"
STATE_DIR="$HOME/.local/state/wallpapers"
PREVIOUS_FILE="$STATE_DIR/previous-space"

if [ ! -f "$CONFIG_FILE" ]; then
    gum style --foreground 196 "❌ Config not found. Run: mise run config:init"
    exit 1
fi

# Get current space
CURRENT=$(swift src/current-space.swift | cut -d'/' -f1)

TARGET="${usage_name:-$1}"

# Handle "-" (go back)
if [ "$TARGET" = "-" ]; then
    if [ ! -f "$PREVIOUS_FILE" ]; then
        gum style --foreground 196 "❌ No previous workspace"
        exit 1
    fi
    TARGET_INDEX=$(cat "$PREVIOUS_FILE")

    if [ "$CURRENT" -eq "$TARGET_INDEX" ]; then
        gum style --foreground 245 "Already on previous workspace"
        exit 0
    fi
# Handle no argument (show picker)
elif [ -z "$TARGET" ]; then
    WORKSPACES=$(jq -r '.workspaces | to_entries[] | "\(.key + 1). \(.value.name)"' "$CONFIG_FILE")

    SELECTION=$(echo "$WORKSPACES" | gum choose --header "Go to workspace:")

    # Extract index from selection (format: "1. name")
    TARGET_INDEX=$(echo "$SELECTION" | cut -d'.' -f1)

    if [ "$CURRENT" -eq "$TARGET_INDEX" ]; then
        gum style --foreground 245 "Already on that workspace"
        exit 0
    fi
# Handle name argument
else
    # Find workspace index by name or id
    TARGET_LOWER=$(echo "$TARGET" | tr '[:upper:]' '[:lower:]')
    TARGET_INDEX=$(jq -r --arg search "$TARGET_LOWER" '
        .workspaces | to_entries[] |
        select(
            (.value.id // (.value.name | ascii_downcase | gsub(" "; "-") | gsub("[^a-z0-9-]"; ""))) == $search
            or (.value.name | ascii_downcase) == $search
        ) |
        .key + 1
    ' "$CONFIG_FILE")

    if [ -z "$TARGET_INDEX" ]; then
        gum style --foreground 196 "❌ Workspace not found: $TARGET"
        exit 1
    fi

    if [ "$CURRENT" -eq "$TARGET_INDEX" ]; then
        gum style --foreground 245 "Already on workspace $TARGET"
        exit 0
    fi
fi

# Save current space before navigating
mkdir -p "$STATE_DIR"
echo "$CURRENT" > "$PREVIOUS_FILE"

# Calculate direction and steps
if [ "$TARGET_INDEX" -gt "$CURRENT" ]; then
    STEPS=$((TARGET_INDEX - CURRENT))
    # Right arrow = key code 124
    KEY_CODE=124
else
    STEPS=$((CURRENT - TARGET_INDEX))
    # Left arrow = key code 123
    KEY_CODE=123
fi

# Navigate
for ((i = 0; i < STEPS; i++)); do
    osascript -e "tell application \"System Events\" to key code $KEY_CODE using control down"
    sleep 0.3
done
