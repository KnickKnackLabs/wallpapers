#!/usr/bin/env bash
#MISE description="Write Hammerspoon config with wp integration"
set -e

CONFIG_DIR="$HOME/.hammerspoon"
CONFIG_FILE="$CONFIG_DIR/init.lua"
REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../.." && pwd)"

mkdir -p "$CONFIG_DIR"

cat > "$CONFIG_FILE" << 'INITLUA'
-- Hammerspoon configuration
-- Managed by wp (wallpapers)
-- wp-integration: v1

-- Enable CLI (hs command) - required for wp integration
require("hs.ipc")

-- Reload config with Cmd+Ctrl+R
hs.hotkey.bind({"cmd", "ctrl"}, "R", function()
    hs.reload()
end)

-- Notify on config load
hs.notify.new({title="Hammerspoon", informativeText="Config loaded"}):send()

--------------------------------------------------
-- wp workspace integration
-- These functions are called by wp for advanced
-- workspace management features
--------------------------------------------------

local wp = {}

-- Get current space number
function wp.currentSpace()
    local screen = hs.screen.mainScreen()
    local spaces = hs.spaces.spacesForScreen(screen)
    local current = hs.spaces.focusedSpace()
    for i, space in ipairs(spaces) do
        if space == current then
            return i
        end
    end
    return 1
end

-- Get total space count
function wp.spaceCount()
    local screen = hs.screen.mainScreen()
    local spaces = hs.spaces.spacesForScreen(screen)
    return #spaces
end

-- Go to space by number
function wp.gotoSpace(num)
    local screen = hs.screen.mainScreen()
    local spaces = hs.spaces.spacesForScreen(screen)
    if num >= 1 and num <= #spaces then
        hs.spaces.gotoSpace(spaces[num])
        return true
    end
    return false
end

-- Add a new space
function wp.addSpace()
    local screen = hs.screen.mainScreen()
    hs.spaces.addSpaceToScreen(screen, true)
    return wp.spaceCount()
end

-- Remove last space (careful!)
function wp.removeSpace()
    local screen = hs.screen.mainScreen()
    local spaces = hs.spaces.spacesForScreen(screen)
    if #spaces > 1 then
        hs.spaces.removeSpace(spaces[#spaces], true)
        return true
    end
    return false
end

-- Move a window to a space
function wp.moveWindowToSpace(appName, spaceNum)
    local app = hs.application.get(appName)
    if app then
        local win = app:mainWindow()
        if win then
            local screen = hs.screen.mainScreen()
            local spaces = hs.spaces.spacesForScreen(screen)
            if spaceNum >= 1 and spaceNum <= #spaces then
                hs.spaces.moveWindowToSpace(win, spaces[spaceNum])
                return true
            end
        end
    end
    return false
end

-- Expose wp functions globally for CLI access
_G.wp = wp

print("wp integration loaded - " .. wp.spaceCount() .. " spaces available")
INITLUA

# Append hotkey with repo path injected
cat >> "$CONFIG_FILE" << HOTKEY

--------------------------------------------------
-- Hotkeys
--------------------------------------------------

-- Apply wallpapers (Cmd+Ctrl+W)
hs.hotkey.bind({"cmd", "ctrl"}, "W", function()
    hs.notify.new({title="Wallpapers", informativeText="Applying..."}):send()
    local task = hs.task.new("/bin/bash", function(exitCode, stdOut, stdErr)
        if exitCode == 0 then
            hs.notify.new({title="Wallpapers", informativeText="Applied"}):send()
        else
            hs.notify.new({title="Wallpapers", informativeText="Failed (exit " .. exitCode .. ")"}):send()
        end
    end, {"-c", "cd $REPO_DIR && mise run apply --wallpapers"})
    task:start()
end)
HOTKEY

echo "Config written to $CONFIG_FILE"

# Reload config if Hammerspoon is running
APP_PATH="/Applications/Hammerspoon.app"
HS_CLI="$APP_PATH/Contents/Frameworks/hs/hs"

if pgrep -x "Hammerspoon" > /dev/null && [ -x "$HS_CLI" ]; then
    "$HS_CLI" -c "hs.reload()" 2>/dev/null && echo "Config reloaded" || true
fi
