#!/usr/bin/env bash
#MISE description="Install and configure Hammerspoon for advanced workspace management"
set -e

# Pinned version - wp manages updates, not Hammerspoon itself
HAMMERSPOON_VERSION="1.1.0"
HAMMERSPOON_URL="https://github.com/Hammerspoon/hammerspoon/releases/download/${HAMMERSPOON_VERSION}/Hammerspoon-${HAMMERSPOON_VERSION}.zip"
APP_PATH="/Applications/Hammerspoon.app"
CONFIG_DIR="$HOME/.hammerspoon"
CONFIG_FILE="$CONFIG_DIR/init.lua"

# Header
gum style \
    --foreground 212 --border-foreground 141 --border double \
    --align center --width 60 --margin "1 2" --padding "1 4" \
    'üî® Hammerspoon Setup' \
    '' \
    'Advanced workspace management for wp'

echo ""

# Step 1: Check if already installed
gum style --foreground 141 --bold "Step 1: Installation"
echo ""

if [ -d "$APP_PATH" ]; then
    gum style --foreground 46 "‚úÖ Hammerspoon is already installed"

    # Check version if possible
    INSTALLED_VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" "$APP_PATH/Contents/Info.plist" 2>/dev/null || echo "unknown")
    gum style --foreground 245 "   Installed version: $INSTALLED_VERSION"
    gum style --foreground 245 "   Expected version: $HAMMERSPOON_VERSION"

    if [ "$INSTALLED_VERSION" != "$HAMMERSPOON_VERSION" ] && [ "$INSTALLED_VERSION" != "unknown" ]; then
        echo ""
        if gum confirm "Different version detected. Reinstall $HAMMERSPOON_VERSION?"; then
            rm -rf "$APP_PATH"
        else
            gum style --foreground 245 "Keeping existing installation"
        fi
    fi
fi

if [ ! -d "$APP_PATH" ]; then
    gum style --foreground 245 "Downloading Hammerspoon $HAMMERSPOON_VERSION..."

    TEMP_DIR=$(mktemp -d)
    trap "rm -rf $TEMP_DIR" EXIT

    gum spin --spinner dot --title "Downloading..." -- \
        curl -L -o "$TEMP_DIR/Hammerspoon.zip" "$HAMMERSPOON_URL"

    gum spin --spinner dot --title "Extracting..." -- \
        unzip -q -o "$TEMP_DIR/Hammerspoon.zip" -d "$TEMP_DIR"

    gum spin --spinner dot --title "Installing to /Applications..." -- \
        mv "$TEMP_DIR/Hammerspoon.app" "$APP_PATH"

    gum style --foreground 46 "‚úÖ Hammerspoon $HAMMERSPOON_VERSION installed"
fi

echo ""

# Step 2: Check if running
gum style --foreground 141 --bold "Step 2: Launch Hammerspoon"
echo ""

if pgrep -x "Hammerspoon" > /dev/null; then
    gum style --foreground 46 "‚úÖ Hammerspoon is running"
else
    gum style --foreground 245 "Hammerspoon needs to be running to continue."
    echo ""

    if gum confirm "Launch Hammerspoon now?"; then
        open "$APP_PATH"

        gum style --foreground 245 "Waiting for Hammerspoon to start..."
        sleep 2

        # Wait for it to actually start
        for i in {1..10}; do
            if pgrep -x "Hammerspoon" > /dev/null; then
                break
            fi
            sleep 1
        done

        if pgrep -x "Hammerspoon" > /dev/null; then
            gum style --foreground 46 "‚úÖ Hammerspoon is running"
        else
            gum style --foreground 226 "‚ö†Ô∏è  Hammerspoon may need manual launch"
            gum style --foreground 245 "   If you see a security dialog, click 'Open'"
            echo ""
            gum confirm "Press enter when Hammerspoon is running..."
        fi
    else
        gum style --foreground 196 "‚ùå Hammerspoon must be running to continue"
        exit 1
    fi
fi

echo ""

# Step 3: Check accessibility permissions
gum style --foreground 141 --bold "Step 3: Accessibility Permissions"
echo ""

# Try to run a simple hs command to test accessibility
# We use the hs CLI that comes with Hammerspoon
HS_CLI="$APP_PATH/Contents/Frameworks/hs/hs"

check_accessibility() {
    if [ -x "$HS_CLI" ]; then
        # Try a simple command that requires accessibility
        RESULT=$("$HS_CLI" -c "return hs.accessibilityState()" 2>/dev/null || echo "error")
        if [ "$RESULT" = "true" ]; then
            return 0
        fi
    fi
    return 1
}

if check_accessibility; then
    gum style --foreground 46 "‚úÖ Accessibility permissions enabled"
else
    gum style --foreground 226 "‚ö†Ô∏è  Accessibility permissions required"
    echo ""
    gum style --foreground 245 "Hammerspoon needs accessibility permissions to control windows and spaces."
    echo ""
    gum style --foreground 255 "To enable:"
    echo "  1. Click the Hammerspoon menu bar icon (üî®)"
    echo "  2. Click 'Preferences...'"
    echo "  3. Click 'Enable Accessibility'"
    echo "  4. Toggle Hammerspoon ON in System Settings"
    echo ""

    gum confirm "Press enter when you've enabled accessibility..."

    # Check again
    if check_accessibility; then
        gum style --foreground 46 "‚úÖ Accessibility permissions enabled"
    else
        gum style --foreground 226 "‚ö†Ô∏è  Could not verify accessibility. Continuing anyway..."
    fi
fi

echo ""

# Step 4: Initialize config
gum style --foreground 141 --bold "Step 4: Configuration"
echo ""

mkdir -p "$CONFIG_DIR"

if [ -f "$CONFIG_FILE" ]; then
    gum style --foreground 46 "‚úÖ Config exists at $CONFIG_FILE"

    # Check if it has our wp integration
    if grep -q "wp-integration" "$CONFIG_FILE" 2>/dev/null; then
        gum style --foreground 245 "   wp integration already configured"
    else
        echo ""
        gum style --foreground 226 "‚ö†Ô∏è  Existing config found without wp integration"
        gum style --foreground 245 "   You may want to add wp integration manually later"
    fi
else
    gum style --foreground 245 "Creating initial Hammerspoon config..."

    cat > "$CONFIG_FILE" << 'INITLUA'
-- Hammerspoon configuration
-- Managed by wp (wallpapers)
-- wp-integration: v1

-- Enable CLI (hs command) - required for wp integration
require("hs.ipc")

-- Reload config with Cmd+Ctrl+R
hs.hotkey.bind({"cmd", "ctrl"}, "R", function()
    hs.reload()
end)

-- Notify on config load
hs.notify.new({title="Hammerspoon", informativeText="Config loaded"}):send()

--------------------------------------------------
-- wp workspace integration
-- These functions are called by wp for advanced
-- workspace management features
--------------------------------------------------

local wp = {}

-- Get current space number
function wp.currentSpace()
    local screen = hs.screen.mainScreen()
    local spaces = hs.spaces.spacesForScreen(screen)
    local current = hs.spaces.focusedSpace()
    for i, space in ipairs(spaces) do
        if space == current then
            return i
        end
    end
    return 1
end

-- Get total space count
function wp.spaceCount()
    local screen = hs.screen.mainScreen()
    local spaces = hs.spaces.spacesForScreen(screen)
    return #spaces
end

-- Go to space by number
function wp.gotoSpace(num)
    local screen = hs.screen.mainScreen()
    local spaces = hs.spaces.spacesForScreen(screen)
    if num >= 1 and num <= #spaces then
        hs.spaces.gotoSpace(spaces[num])
        return true
    end
    return false
end

-- Add a new space
function wp.addSpace()
    local screen = hs.screen.mainScreen()
    hs.spaces.addSpaceToScreen(screen, true)
    return wp.spaceCount()
end

-- Remove last space (careful!)
function wp.removeSpace()
    local screen = hs.screen.mainScreen()
    local spaces = hs.spaces.spacesForScreen(screen)
    if #spaces > 1 then
        hs.spaces.removeSpace(spaces[#spaces], true)
        return true
    end
    return false
end

-- Move a window to a space
function wp.moveWindowToSpace(appName, spaceNum)
    local app = hs.application.get(appName)
    if app then
        local win = app:mainWindow()
        if win then
            local screen = hs.screen.mainScreen()
            local spaces = hs.spaces.spacesForScreen(screen)
            if spaceNum >= 1 and spaceNum <= #spaces then
                hs.spaces.moveWindowToSpace(win, spaces[spaceNum])
                return true
            end
        end
    end
    return false
end

-- Expose wp functions globally for CLI access
_G.wp = wp

print("wp integration loaded - " .. wp.spaceCount() .. " spaces available")
INITLUA

    gum style --foreground 46 "‚úÖ Config created at $CONFIG_FILE"

    # Reload Hammerspoon config
    if [ -x "$HS_CLI" ]; then
        gum spin --spinner dot --title "Reloading Hammerspoon config..." -- \
            "$HS_CLI" -c "hs.reload()" 2>/dev/null || true
        sleep 1
    fi
fi

echo ""

# Step 5: Verify integration
gum style --foreground 141 --bold "Step 5: Verify Integration"
echo ""

if [ -x "$HS_CLI" ]; then
    SPACE_COUNT=$("$HS_CLI" -c "return wp.spaceCount()" 2>/dev/null || echo "error")
    CURRENT_SPACE=$("$HS_CLI" -c "return wp.currentSpace()" 2>/dev/null || echo "error")

    if [ "$SPACE_COUNT" != "error" ] && [ "$CURRENT_SPACE" != "error" ]; then
        gum style --foreground 46 "‚úÖ wp integration working!"
        gum style --foreground 245 "   Current space: $CURRENT_SPACE of $SPACE_COUNT"
    else
        gum style --foreground 226 "‚ö†Ô∏è  Could not verify wp integration"
        gum style --foreground 245 "   This might be okay - try reloading Hammerspoon (Cmd+Ctrl+R)"
    fi
else
    gum style --foreground 226 "‚ö†Ô∏è  Hammerspoon CLI not found"
    gum style --foreground 245 "   The hs command should be at: $HS_CLI"
fi

echo ""

# Done!
gum style \
    --foreground 46 --border-foreground 46 --border rounded \
    --align center --width 60 --margin "1 2" --padding "1 4" \
    'üéâ Hammerspoon Setup Complete!' \
    '' \
    'Advanced workspace features are now available'

echo ""
gum style --foreground 245 "Next steps:"
echo "  ‚Ä¢ wp hammerspoon:status  - Check Hammerspoon status"
echo "  ‚Ä¢ wp hammerspoon:test    - Test workspace functions"
echo ""
