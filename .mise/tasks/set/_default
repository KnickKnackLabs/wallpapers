#!/usr/bin/env bash
#MISE description="Set wallpaper for current desktop space"
set -e

OUTPUT_DIR="$HOME/.local/share/wallpapers"

# Check for generated wallpapers
if [ ! -d "$OUTPUT_DIR" ] || [ -z "$(ls "$OUTPUT_DIR"/*.png 2>/dev/null)" ]; then
    gum style --foreground 196 "‚ùå No wallpapers found. Run 'mise run generate' first."
    exit 1
fi

gum style \
    --foreground 212 --border-foreground 212 --border double \
    --align center --width 50 --margin "1 2" --padding "1 2" \
    'üñ•Ô∏è Set Desktop Wallpaper'

# Show current space
SPACE_INFO=$(swift src/current-space.swift 2>/dev/null)
if [ -n "$SPACE_INFO" ]; then
    CURRENT=$(echo "$SPACE_INFO" | cut -d'/' -f1)
    TOTAL=$(echo "$SPACE_INFO" | cut -d'/' -f2)
    gum style --foreground 46 "üìç You are on Desktop $CURRENT of $TOTAL"
fi
echo ""

# Let user pick a wallpaper
WALLPAPER=$(ls "$OUTPUT_DIR"/*.png | xargs -n1 basename | gum choose --header "Select wallpaper:")

if [ -z "$WALLPAPER" ]; then
    gum style --foreground 196 "‚ùå No wallpaper selected"
    exit 1
fi

# Get absolute path
WALLPAPER_PATH="$OUTPUT_DIR/$WALLPAPER"

# Set wallpaper for current desktop using osascript
osascript -e "tell application \"System Events\" to set picture of current desktop to \"$WALLPAPER_PATH\""

gum style --foreground 46 "‚úÖ Wallpaper set: $WALLPAPER"
