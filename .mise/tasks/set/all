#!/usr/bin/env bash
#MISE description="Set wallpaper for all spaces (loops through each)"
set -e

OUTPUT_DIR="$HOME/.local/share/wallpapers"

if [ ! -d "$OUTPUT_DIR" ] || [ -z "$(ls "$OUTPUT_DIR"/*.png 2>/dev/null)" ]; then
    gum style --foreground 196 "‚ùå No wallpapers found. Run 'mise run generate' first."
    exit 1
fi

gum style \
    --foreground 212 --border-foreground 212 --border double \
    --align center --width 50 --margin "1 2" --padding "1 2" \
    'üñ•Ô∏è Set Wallpaper (All Spaces)'

gum style --foreground 244 "‚ö†Ô∏è  macOS limitation: We need to switch to each space to set its wallpaper."
gum style --foreground 244 "This will cycle through your spaces using Ctrl+Arrow keys."
echo ""

# Auto-detect current space and total spaces
SPACE_INFO=$(swift src/current-space.swift 2>/dev/null)
if [ -n "$SPACE_INFO" ]; then
    CURRENT_SPACE=$(echo "$SPACE_INFO" | cut -d'/' -f1)
    NUM_SPACES=$(echo "$SPACE_INFO" | cut -d'/' -f2)
    gum style --foreground 46 "‚úì Detected: Desktop $CURRENT_SPACE of $NUM_SPACES"
else
    gum style --foreground 214 "‚ö†Ô∏è  Could not auto-detect spaces, please enter manually:"
    NUM_SPACES=$(gum input --placeholder "5" --prompt "How many spaces do you have? ")
    NUM_SPACES=${NUM_SPACES:-5}
    CURRENT_SPACE=$(gum input --placeholder "1" --prompt "Which desktop are you on now? ")
    CURRENT_SPACE=${CURRENT_SPACE:-1}
fi
echo ""

WALLPAPER=$(ls "$OUTPUT_DIR"/*.png | xargs -n1 basename | gum choose --header "Select wallpaper:")

if [ -z "$WALLPAPER" ]; then
    gum style --foreground 196 "‚ùå No wallpaper selected"
    exit 1
fi

WALLPAPER_PATH="$OUTPUT_DIR/$WALLPAPER"

gum style --foreground 214 "üîÑ Starting in 3 seconds... Don't touch anything!"
sleep 3

# Go to Desktop 1 (only the necessary number of times)
STEPS_LEFT=$((CURRENT_SPACE - 1))
if [ "$STEPS_LEFT" -gt 0 ]; then
    gum style --foreground 244 "Navigating to Desktop 1..."
    for i in $(seq 1 "$STEPS_LEFT"); do
        osascript -e 'tell application "System Events" to key code 123 using control down'
        sleep 0.3
    done
    sleep 0.5
fi

# Loop through spaces, setting wallpaper on each
for i in $(seq 1 "$NUM_SPACES"); do
    # Set wallpaper for current space
    osascript -e "tell application \"System Events\" to set picture of current desktop to \"$WALLPAPER_PATH\""

    # Move to next space (Ctrl+Right)
    if [ "$i" -lt "$NUM_SPACES" ]; then
        osascript -e 'tell application "System Events" to key code 124 using control down'
        sleep 0.5
    fi
done

# Return to original desktop
STEPS_TO_RETURN=$((NUM_SPACES - CURRENT_SPACE))
if [ "$STEPS_TO_RETURN" -gt 0 ]; then
    gum style --foreground 244 "Returning to Desktop $CURRENT_SPACE..."
    for i in $(seq 1 "$STEPS_TO_RETURN"); do
        osascript -e 'tell application "System Events" to key code 123 using control down'
        sleep 0.3
    done
fi

gum style --foreground 46 "‚úÖ Wallpaper set on $NUM_SPACES spaces: $WALLPAPER"
