# Mise tasks for wallpaper generation
# Uses gum for beautiful CLI interactions
# Swift for zero-dependency image generation

[tasks.generate]
description = "Generate a wallpaper interactively"
run = """
#!/usr/bin/env bash
set -e

# Styled header
gum style \
    --foreground 212 --border-foreground 212 --border double \
    --align center --width 50 --margin "1 2" --padding "1 2" \
    'üñºÔ∏è Wallpaper Generator'

# Get workspace name
NAME=$(gum input --placeholder "Workspace name (e.g., 'Code', 'Design')" --prompt "üìù Name: ")

if [ -z "$NAME" ]; then
    gum style --foreground 196 "‚ùå Name is required"
    exit 1
fi

# Ask for optional description
DESC_ARG=""
if gum confirm "Add a description?"; then
    DESCRIPTION=$(gum input --placeholder "Brief description" --prompt "üìã Description: ")
    if [ -n "$DESCRIPTION" ]; then
        DESC_ARG="--description"
    fi
fi

# Detect current screen resolution
SCREEN_RES=$(system_profiler SPDisplaysDataType | grep -i "Resolution:" | head -1 | sed 's/.*: //' | sed 's/ Retina//' | sed 's/ //g')
SCREEN_W=$(echo "$SCREEN_RES" | cut -d'x' -f1)
SCREEN_H=$(echo "$SCREEN_RES" | cut -d'x' -f2)

# Select resolution
RESOLUTION=$(gum choose --header "üìê Select resolution:" \
    "auto (${SCREEN_W}x${SCREEN_H} - your screen) (Recommended)" \
    "1080p (1920x1080)" \
    "1440p (2560x1440)" \
    "4k (3840x2160)" \
    "macbook-14 (3024x1964)" \
    "macbook-16 (3456x2234)" \
    "imac-24 (4480x2520)" \
    "studio-display (5120x2880)")

# Extract resolution - handle auto-detect
if [[ "$RESOLUTION" == auto* ]]; then
    RES_ARGS="--width $SCREEN_W --height $SCREEN_H"
else
    RES_KEY=$(echo "$RESOLUTION" | cut -d' ' -f1)
    RES_ARGS="-r $RES_KEY"
fi

# Select colors
gum style --foreground 244 "üé® Color scheme"
BG_COLOR=$(gum choose --header "Background:" \
    "#000000 (Black)" \
    "#1a1a2e (Dark Navy)" \
    "#16213e (Deep Blue)" \
    "#0f3460 (Ocean)" \
    "#2d3436 (Charcoal)" \
    "#ffffff (White)" \
    "custom")

if [ "$BG_COLOR" = "custom" ]; then
    BG_COLOR=$(gum input --placeholder "#000000" --prompt "Custom hex: ")
else
    BG_COLOR=$(echo "$BG_COLOR" | cut -d' ' -f1)
fi

TEXT_COLOR=$(gum choose --header "Text color:" \
    "#ffffff (White)" \
    "#e94560 (Red)" \
    "#00d9ff (Cyan)" \
    "#00ff88 (Green)" \
    "#ffd93d (Yellow)" \
    "#c9b1ff (Lavender)" \
    "custom")

if [ "$TEXT_COLOR" = "custom" ]; then
    TEXT_COLOR=$(gum input --placeholder "#ffffff" --prompt "Custom hex: ")
else
    TEXT_COLOR=$(echo "$TEXT_COLOR" | cut -d' ' -f1)
fi

# Build and run Swift generator
gum spin --spinner dot --title "Generating wallpaper..." -- \
    swift src/generate.swift "$NAME" \
        $RES_ARGS \
        --bg-color "$BG_COLOR" \
        --text-color "$TEXT_COLOR" \
        $DESC_ARG ${DESCRIPTION:+"$DESCRIPTION"}

gum style --foreground 46 "‚úÖ Wallpaper generated! Check the output/ directory."

# Show the generated files
ls -la output/
"""

[tasks.quick]
description = "Quick generate with just a name (auto-detects screen resolution)"
run = """
#!/usr/bin/env bash
set -e

NAME=$(gum input --placeholder "Workspace name" --prompt "üìù Quick generate: ")

if [ -z "$NAME" ]; then
    gum style --foreground 196 "‚ùå Name is required"
    exit 1
fi

# Auto-detect screen resolution
SCREEN_RES=$(system_profiler SPDisplaysDataType | grep -i "Resolution:" | head -1 | sed 's/.*: //' | sed 's/ Retina//' | sed 's/ //g')
SCREEN_W=$(echo "$SCREEN_RES" | cut -d'x' -f1)
SCREEN_H=$(echo "$SCREEN_RES" | cut -d'x' -f2)

gum spin --spinner dot --title "Generating at ${SCREEN_W}x${SCREEN_H}..." -- \
    swift src/generate.swift "$NAME" --width "$SCREEN_W" --height "$SCREEN_H"

gum style --foreground 46 "‚úÖ Done! Saved to output/"
"""

[tasks.cli]
description = "Run generator directly with arguments"
run = "swift src/generate.swift"

[tasks.list]
description = "List generated wallpapers"
run = """
#!/usr/bin/env bash
if [ -d output ] && [ "$(ls -A output 2>/dev/null)" ]; then
    gum style --foreground 212 --bold "üìÅ Generated Wallpapers:"
    ls -lh output/*.png 2>/dev/null | awk '{print "  " $9 " (" $5 ")"}'
else
    gum style --foreground 244 "No wallpapers generated yet. Run 'mise run generate' to create one."
fi
"""

[tasks.clean]
description = "Remove all generated wallpapers"
run = """
#!/usr/bin/env bash
if gum confirm "Delete all generated wallpapers?"; then
    rm -rf output/*.png
    gum style --foreground 46 "‚úÖ Cleaned output directory"
else
    gum style --foreground 244 "Cancelled"
fi
"""

[tasks.open]
description = "Open the output directory in Finder"
run = "open output/"

[tasks.help]
description = "Show generator CLI help"
run = "swift src/generate.swift --help"

[tasks.set]
description = "Set wallpaper for current desktop space"
run = """
#!/usr/bin/env bash
set -e

# Check for generated wallpapers
if [ ! -d output ] || [ -z "$(ls output/*.png 2>/dev/null)" ]; then
    gum style --foreground 196 "‚ùå No wallpapers found. Run 'mise run generate' first."
    exit 1
fi

gum style \
    --foreground 212 --border-foreground 212 --border double \
    --align center --width 50 --margin "1 2" --padding "1 2" \
    'üñ•Ô∏è Set Desktop Wallpaper'

# Show current space
SPACE_INFO=$(swift src/current-space.swift 2>/dev/null)
if [ -n "$SPACE_INFO" ]; then
    CURRENT=$(echo "$SPACE_INFO" | cut -d'/' -f1)
    TOTAL=$(echo "$SPACE_INFO" | cut -d'/' -f2)
    gum style --foreground 46 "üìç You are on Desktop $CURRENT of $TOTAL"
fi
echo ""

# Let user pick a wallpaper
WALLPAPER=$(ls output/*.png | xargs -n1 basename | gum choose --header "Select wallpaper:")

if [ -z "$WALLPAPER" ]; then
    gum style --foreground 196 "‚ùå No wallpaper selected"
    exit 1
fi

# Get absolute path
WALLPAPER_PATH="$(cd output && pwd)/$WALLPAPER"

# Set wallpaper for current desktop using osascript
osascript -e "tell application \\"System Events\\" to set picture of current desktop to \\"$WALLPAPER_PATH\\""

gum style --foreground 46 "‚úÖ Wallpaper set: $WALLPAPER"
"""

[tasks."set:all"]
description = "Set wallpaper for all spaces (loops through each)"
run = """
#!/usr/bin/env bash
set -e

if [ ! -d output ] || [ -z "$(ls output/*.png 2>/dev/null)" ]; then
    gum style --foreground 196 "‚ùå No wallpapers found. Run 'mise run generate' first."
    exit 1
fi

gum style \
    --foreground 212 --border-foreground 212 --border double \
    --align center --width 50 --margin "1 2" --padding "1 2" \
    'üñ•Ô∏è Set Wallpaper (All Spaces)'

gum style --foreground 244 "‚ö†Ô∏è  macOS limitation: We need to switch to each space to set its wallpaper."
gum style --foreground 244 "This will cycle through your spaces using Ctrl+Arrow keys."
echo ""

# Auto-detect current space and total spaces
SPACE_INFO=$(swift src/current-space.swift 2>/dev/null)
if [ -n "$SPACE_INFO" ]; then
    CURRENT_SPACE=$(echo "$SPACE_INFO" | cut -d'/' -f1)
    NUM_SPACES=$(echo "$SPACE_INFO" | cut -d'/' -f2)
    gum style --foreground 46 "‚úì Detected: Desktop $CURRENT_SPACE of $NUM_SPACES"
else
    gum style --foreground 214 "‚ö†Ô∏è  Could not auto-detect spaces, please enter manually:"
    NUM_SPACES=$(gum input --placeholder "5" --prompt "How many spaces do you have? ")
    NUM_SPACES=${NUM_SPACES:-5}
    CURRENT_SPACE=$(gum input --placeholder "1" --prompt "Which desktop are you on now? ")
    CURRENT_SPACE=${CURRENT_SPACE:-1}
fi
echo ""

WALLPAPER=$(ls output/*.png | xargs -n1 basename | gum choose --header "Select wallpaper:")

if [ -z "$WALLPAPER" ]; then
    gum style --foreground 196 "‚ùå No wallpaper selected"
    exit 1
fi

WALLPAPER_PATH="$(cd output && pwd)/$WALLPAPER"

gum style --foreground 214 "üîÑ Starting in 3 seconds... Don't touch anything!"
sleep 3

# Go to Desktop 1 (only the necessary number of times)
STEPS_LEFT=$((CURRENT_SPACE - 1))
if [ "$STEPS_LEFT" -gt 0 ]; then
    gum style --foreground 244 "Navigating to Desktop 1..."
    for i in $(seq 1 "$STEPS_LEFT"); do
        osascript -e 'tell application "System Events" to key code 123 using control down'
        sleep 0.3
    done
    sleep 0.5
fi

# Loop through spaces, setting wallpaper on each
for i in $(seq 1 "$NUM_SPACES"); do
    # Set wallpaper for current space
    osascript -e "tell application \\"System Events\\" to set picture of current desktop to \\"$WALLPAPER_PATH\\""

    # Move to next space (Ctrl+Right)
    if [ "$i" -lt "$NUM_SPACES" ]; then
        osascript -e 'tell application "System Events" to key code 124 using control down'
        sleep 0.5
    fi
done

# Return to original desktop
STEPS_TO_RETURN=$((NUM_SPACES - CURRENT_SPACE))
if [ "$STEPS_TO_RETURN" -gt 0 ]; then
    gum style --foreground 244 "Returning to Desktop $CURRENT_SPACE..."
    for i in $(seq 1 "$STEPS_TO_RETURN"); do
        osascript -e 'tell application "System Events" to key code 123 using control down'
        sleep 0.3
    done
fi

gum style --foreground 46 "‚úÖ Wallpaper set on $NUM_SPACES spaces: $WALLPAPER"
"""

[tasks.resolution]
description = "Show your screen resolution"
run = """
#!/usr/bin/env bash
SCREEN_RES=$(system_profiler SPDisplaysDataType | grep -i "Resolution:" | head -1 | sed 's/.*: //' | sed 's/ Retina//' | sed 's/ //g')
gum style --foreground 212 "üñ•Ô∏è Your screen resolution: $SCREEN_RES"
gum style --foreground 244 "Use 'mise run quick' to auto-generate at this size"
"""

[tasks.space]
description = "Show current desktop space"
run = """
#!/usr/bin/env bash
SPACE_INFO=$(swift src/current-space.swift 2>/dev/null)
if [ -n "$SPACE_INFO" ]; then
    CURRENT=$(echo "$SPACE_INFO" | cut -d'/' -f1)
    TOTAL=$(echo "$SPACE_INFO" | cut -d'/' -f2)
    gum style --foreground 212 "üìç Desktop $CURRENT of $TOTAL"
else
    gum style --foreground 196 "‚ùå Could not detect current space"
fi
"""
